{% extends "base.html" %} {% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h5 class="q-my-none">Nostr Wallet Connect (NIP-47)</h5>
        <p>
          Connect your LNBits wallet to Nostr applications using the NIP-47
          protocol.
        </p>
      </q-card-section>
    </q-card>

    <q-card>
      <q-card-section>
        <div class="row items-center no-wrap q-mb-md">
          <div class="col">
            <h6 class="q-my-none">Active Connections</h6>
          </div>
          <div class="col-auto">
            <q-btn
              unelevated
              color="primary"
              @click="showCreateDialog = true"
              icon="add"
              label="New Connection"
            ></q-btn>
          </div>
        </div>

        <q-table
          flat
          dense
          :rows="connections"
          :columns="connectionsTable.columns"
          row-key="id"
          :pagination.sync="connectionsTable.pagination"
        >
          <template v-slot:header="props">
            <q-tr :props="props">
              <q-th auto-width></q-th>
              <q-th v-for="col in props.cols" :key="col.name" :props="props">
                {{ col.label }}
              </q-th>
            </q-tr>
          </template>

          <template v-slot:body="props">
            <q-tr :props="props">
              <q-td auto-width>
                <q-btn
                  unelevated
                  dense
                  size="xs"
                  icon="qr_code"
                  color="primary"
                  @click="showConnectionString(props.row)"
                ></q-btn>
                <q-btn
                  unelevated
                  dense
                  size="xs"
                  icon="delete"
                  color="negative"
                  @click="deleteConnection(props.row.id)"
                ></q-btn>
              </q-td>
              <q-td v-for="col in props.cols" :key="col.name" :props="props">
                {{ col.value }}
              </q-td>
            </q-tr>
          </template>
        </q-table>
      </q-card-section>
    </q-card>
  </div>

  <div class="col-12 col-md-4 col-lg-5 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <h6 class="q-my-none">About NIP-47</h6>
        <p class="q-mt-md">
          NIP-47 (Nostr Wallet Connect) allows Nostr applications to request
          actions from your Lightning wallet. You can:
        </p>
        <ul>
          <li>Pay invoices from Nostr apps</li>
          <li>Create invoices</li>
          <li>Check your balance</li>
          <li>View transaction history</li>
        </ul>
        <p>
          Each connection has its own keypair and permissions. You can revoke
          access at any time.
        </p>
      </q-card-section>
    </q-card>
  </div>
</div>

<!-- Create Connection Dialog -->
<q-dialog v-model="showCreateDialog" position="top">
  <q-card class="q-pa-lg lnbits__dialog-card">
    <q-card-section>
      <h6 class="q-my-none">Create New Connection</h6>
    </q-card-section>
    <q-card-section>
      <q-form @submit="createConnection" class="q-gutter-md">
        <q-input
          filled
          v-model="newConnection.name"
          label="Connection Name"
          hint="A friendly name for this connection"
        ></q-input>

        <q-input
          filled
          v-model="newConnection.relay_url"
          label="Nostr Relay URL"
          hint="The Nostr relay to use for communication"
        ></q-input>

        <q-select
          filled
          v-model="newConnection.permissions"
          multiple
          :options="availablePermissions"
          label="Permissions"
          hint="What actions this connection can perform"
        ></q-select>

        <div class="row q-mt-lg">
          <q-btn
            unelevated
            color="primary"
            type="submit"
            label="Create"
          ></q-btn>
          <q-btn
            flat
            color="grey"
            class="q-ml-auto"
            @click="showCreateDialog = false"
            label="Cancel"
          ></q-btn>
        </div>
      </q-form>
    </q-card-section>
  </q-card>
</q-dialog>

<!-- Connection String Dialog -->
<q-dialog v-model="showConnectionStringDialog" position="top">
  <q-card class="q-pa-lg lnbits__dialog-card">
    <q-card-section>
      <h6 class="q-my-none">Connection String</h6>
    </q-card-section>
    <q-card-section v-if="selectedConnection">
      <p>Use this connection string in your Nostr application:</p>
      <q-input
        filled
        readonly
        v-model="connectionString"
        type="textarea"
        rows="4"
      >
        <template v-slot:append>
          <q-btn
            flat
            dense
            icon="content_copy"
            @click="copyConnectionString"
          ></q-btn>
        </template>
      </q-input>
      <div class="q-mt-md text-center">
        <qrcode
          :value="connectionString"
          :options="{width: 300}"
          v-if="connectionString"
        ></qrcode>
      </div>
    </q-card-section>
    <q-card-section>
      <q-btn
        flat
        color="grey"
        @click="showConnectionStringDialog = false"
        label="Close"
      ></q-btn>
    </q-card-section>
  </q-card>
</q-dialog>

{% endblock %} {% block scripts %}
<script>
  new Vue({
    el: '#vue',
    mixins: [windowMixin],
    data: function () {
      return {
        connections: [],
        showCreateDialog: false,
        showConnectionStringDialog: false,
        selectedConnection: null,
        connectionString: '',
        newConnection: {
          name: '',
          relay_url: 'wss://relay.damus.io',
          permissions: [
            'pay_invoice',
            'get_balance',
            'get_info',
            'make_invoice',
            'lookup_invoice',
            'list_transactions'
          ]
        },
        availablePermissions: [
          'pay_invoice',
          'get_balance',
          'get_info',
          'make_invoice',
          'lookup_invoice',
          'list_transactions'
        ],
        connectionsTable: {
          columns: [
            {
              name: 'name',
              align: 'left',
              label: 'Name',
              field: 'name'
            },
            {
              name: 'relay_url',
              align: 'left',
              label: 'Relay',
              field: 'relay_url'
            },
            {
              name: 'enabled',
              align: 'left',
              label: 'Status',
              field: 'enabled',
              format: val => (val ? 'Active' : 'Disabled')
            },
            {
              name: 'created_at',
              align: 'left',
              label: 'Created',
              field: 'created_at',
              format: val => new Date(val * 1000).toLocaleDateString()
            }
          ],
          pagination: {
            rowsPerPage: 10
          }
        }
      }
    },
    methods: {
      getConnections: function () {
        LNbits.api
          .request(
            'GET',
            '/nostrwallet/api/v1/connections',
            this.g.user.wallets[0].inkey
          )
          .then(response => {
            this.connections = response.data
          })
          .catch(err => {
            LNbits.utils.notifyApiError(err)
          })
      },
      createConnection: function () {
        const data = {
          ...this.newConnection,
          permissions: JSON.stringify(this.newConnection.permissions)
        }

        LNbits.api
          .request(
            'POST',
            '/nostrwallet/api/v1/connections',
            this.g.user.wallets[0].adminkey,
            data
          )
          .then(response => {
            this.connections.push(response.data)
            this.showCreateDialog = false
            this.newConnection = {
              name: '',
              relay_url: 'wss://relay.damus.io',
              permissions: [
                'pay_invoice',
                'get_balance',
                'get_info',
                'make_invoice',
                'lookup_invoice',
                'list_transactions'
              ]
            }
            this.$q.notify({
              type: 'positive',
              message: 'Connection created successfully'
            })
          })
          .catch(err => {
            LNbits.utils.notifyApiError(err)
          })
      },
      showConnectionString: function (connection) {
        this.selectedConnection = connection
        LNbits.api
          .request('GET', `/nostrwallet/api/v1/info/${connection.id}`)
          .then(response => {
            this.connectionString = response.data.connection_string
            this.showConnectionStringDialog = true
          })
          .catch(err => {
            LNbits.utils.notifyApiError(err)
          })
      },
      copyConnectionString: function () {
        navigator.clipboard.writeText(this.connectionString)
        this.$q.notify({
          type: 'positive',
          message: 'Connection string copied to clipboard'
        })
      },
      deleteConnection: function (connectionId) {
        LNbits.utils
          .confirmDialog('Are you sure you want to delete this connection?')
          .onOk(() => {
            LNbits.api
              .request(
                'DELETE',
                `/nostrwallet/api/v1/connections/${connectionId}`,
                this.g.user.wallets[0].adminkey
              )
              .then(() => {
                this.connections = this.connections.filter(
                  c => c.id !== connectionId
                )
                this.$q.notify({
                  type: 'positive',
                  message: 'Connection deleted'
                })
              })
              .catch(err => {
                LNbits.utils.notifyApiError(err)
              })
          })
      }
    },
    created: function () {
      this.getConnections()
    }
  })
</script>
{% endblock %}
